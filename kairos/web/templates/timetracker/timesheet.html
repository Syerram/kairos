{% load tracker_tags %}
<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
	<script type="text/javascript" src="/static/js/jquery.hoverIntent.minified.js"></script>
	<script type="text/javascript" src="/static/js/jquery.formset.js"></script>
	<script type="text/javascript" src="/static/js/jquery.numeric.js"></script>	
	 
	<link rel="stylesheet" href="/static/css/timesheet.css" type="text/css" media="screen">
	<link rel="stylesheet" href="/static/css/glyphicon-icons.css" type="text/css" media="screen">
	<link href="/static/css/bootstrap.css" rel="stylesheet" />
	<meta charset="ISO-8859-1">
    <title>Kairos | Timesheet</title>
    <script type="text/javascript">
		function makeTall() {
			$(this).stop().animate({
				"height" : 75
			}, 15);
		}
		
		function makeShort() {
			$(this).stop().animate({
				"height" : 16
			}, 15);
		}
		
		function update_totals() {
            var orig_hours = parseFloat($(this).data('hours'));
            var new_hours = parseFloat(this.value);
            if(orig_hours!=this.value) {
                var day_total_hours_class= '.' +  $(this).data('ptr-total-hours');
                var day_total_hours = parseFloat($(day_total_hours_class).text());
                day_total_hours = day_total_hours - orig_hours + new_hours;
                $(day_total_hours_class).text(day_total_hours.toFixed(2));
                
                var row_totals_elem = $(this).parent().parent().find('span');
                var row_totals = parseFloat(row_totals_elem.text());
                row_totals = row_totals - orig_hours + new_hours;
                row_totals_elem.text(row_totals.toFixed(2));
                
                var total_hours = parseFloat($('.total_hours').text());
                total_hours = total_hours - orig_hours + new_hours;
                $('.total_hours').text(total_hours.toFixed(2));
                
                $(this).data('hours', new_hours);
            }        
		}

		function added_row(row) {
			console.info(row);
		}
		
		$(document).ready(function() {		
	// 		$('#menu li.drop').hoverIntent(makeTall, makeShort);
	
	       {% if week_snapshot.last_status.weeksnapshot_status|is_editable %}		    
			    $('.reset').click(function(e) {
			    	e.preventDefault();
			    	$('#time-table .hour-input').val('');
			    });
			    
			    $('.hour-input').numeric({decimal: ".", negative: false}, null, update_totals);
			    
			    $('.project-dropdown').change(function() {
			    	if($(this).val) {
				    	$.get('/activities/'+ $(this).val(), function(data) {
				    		  $('.activity-dropdown').empty().append($(data));
				    	});
			    	}
			    });
			    
			    $('#id_submit').click(function(e) {
			    	$('#id_is_draft').val('false');
			    	return true;
			    });
			    
			    $('#id_timesheet tbody tr').formset({
			    	addText: '',
			        addCssClass:'sprite-glyphicons_190_circle_plus',
			        deleteText:'',
			        deleteCssClass:'sprite-glyphicons_016_bin',
			        added: added_row,
			    });
		    {% else %}
		        $('.hour-input').prop('disabled', true);
		        $('.hour-input').css('background-color', 'silver');
		        $('#id_submit').prop('value', 'Print');
		        $('#id_draft').hide();
		        $('.reset').hide();
		        //rest of disabling goes here		        
		    {% endif %}
		});
	</script>
</head>
<body>
	<div class="header">
		<div id="dashboard">
			<span class="welcome-user">Welcome
				{{request.user.first_name}}, {{request.user.last_name}}</span>
			<ul id="menu">
				<li>My Profile</li>
				<li class="drop">Reports</li>
				<li class="drop">Logout</li>
			</ul>
		</div>
	</div>
    <div class="row" style="margin: 25px 0 0 20%;">
			<div class="span12 timesheet-header" style="width:820px !important;">
			    <div class="title" style="float:left;">
			         <span>Week {{week}} - {{week_snapshot.last_status.weeksnapshot_status.display}}</span>
			    </div>     
				<div class="week-spanner" style="float: right;">				    
			        <a href='/timesheet/{{week|add:"-1"}}' class="grey-button week-backward"><i class="sprite-glyphicons_224_thin_arrow_left" style="margin:5px 1px 0 0;"></i></a>
					<span class="week-display" >{{week_snapshot.start_week|date:"d.NY"}} -
						{{week_snapshot.end_week|date:"d.NY"}}</span>
					{% if week_snapshot.end_week|is_in_future %}
					   <a href='#' class="grey-button week-forward disable-link"><i class="sprite-glyphicons_223_thin_right_arrow" style="margin:5px 1px 0 0;"></i></a>
					{% else %}
					   <a href='/timesheet/{{week|add:"1"}}' class="grey-button week-forward"><i class="sprite-glyphicons_223_thin_right_arrow" style="margin:5px 1px 0 0;"></i></a>
					{% endif %}
				</div>
			</div>
			<form id="id_timesheet" name="timesheet" action="/timesheet/{{week}}/" method="POST">
			     {% csrf_token %}
				<div class="span12 time-logging" style="clear: both;width:820px !important;">
					<div class="time-logging-header">
					    
						<table id="time-table" cellspacing="0" summary="Time sheet">
							<thead>
								<tr id="header">
									<th scope="col" abbr="Project"><span style="display: block">Projects</span>
									<th scope="col" abbr="Project"><span style="display: block">Activity</span>
									<th scope="col" abbr="Monday">
									    <span style="display: block; margin-left: 5px;">Mon</span>
									    <span style="display: block; font-weight: normal; font-size: 10px;">{{week_snapshot.start_week|date:"d"}}</span></th>
									<th scope="col" abbr="Tuesday">
									    <span style="display: block; margin-left: 5px;">Tue</span>
                                        <span style="display: block; font-weight: normal; font-size: 10px;">{{week_snapshot.start_week|day_plus:"1"|date:"d"}}</span></th>
									<th scope="col" abbr="Wednesday">
									   <span style="display: block; margin-left: 5px;">Wed</span>
                                        <span style="display: block; font-weight: normal; font-size: 10px;">{{week_snapshot.start_week|day_plus:"2"|date:"d"}}</span></th>
									<th scope="col" abbr="Thursday">
									   <span style="display: block; margin-left: 5px;">Thu</span>
                                        <span style="display: block; font-weight: normal; font-size: 10px;">{{week_snapshot.start_week|day_plus:"3"|date:"d"}}</span></th>
									<th scope="col" abbr="Friday">
									   <span style="display: block; margin-left: 5px;">Fri</span>
                                        <span style="display: block; font-weight: normal; font-size: 10px;">{{week_snapshot.start_week|day_plus:"4"|date:"d"}}</span></th>
									<th scope="col" abbr="Saturday">
									   <span style="display: block; margin-left: 5px;">Sat</span>
                                        <span style="display: block; font-weight: normal; font-size: 10px;">{{week_snapshot.start_week|day_plus:"5"|date:"d"}}</span></th>
									<th scope="col" abbr="Sunday">
									   <span style="display: block; margin-left: 5px;">Sun</span>
                                        <span style="display: block; font-weight: normal; font-size: 10px;">{{week_snapshot.start_week|day_plus:"6"|date:"d"}}</span></th>
                                    <th scope="col"><span>Total</span></th>
									<th scope="col" abbr="action"></th>
								</tr>
							</thead>
							<tbody>
							    {% for timesheet_form in timesheet_form_set.forms %}							        						       
									    <tr>								    
	                                        <td>	                                            
	                                            {{timesheet_form.id}}                                                                                            
	                                            <div id="project-dropdown">										    
													<select name="{{timesheet_form.project.html_name}}" data-activity-element="{{timesheet_form.project.auto_id}}" 
													       class="dropdown-select project-dropdown" id="{{timesheet_form.project.auto_id}}">
														<option value="0" class="dropdown-option">Choose Project</option>
														{% for project in projects.all %}
														      {% if project.id == timesheet_form.initial.project %}
														          <option value="{{project.id}}" class="dropdown-option" selected="selected">{{project.name}}</option>
														      {% else %}
														          <option value="{{project.id}}" class="dropdown-option">{{project.name}}</option>														          
														      {% endif %}														        
														{% endfor %}
													</select>
													<input type="hidden" value="{{timesheet_form.project_id}}"/>
												</div>
											</td>
											<td>
											     <div id="activity-dropdown">
				                                    <select name="{{timesheet_form.activity.html_name}}" class="dropdown-select activity-dropdown" id="{{timesheet_form.activity.auto_id}}">				                                        
				                                        {% activity_dropdown timesheet_form.initial.project timesheet_form.initial.activity %}                                 
				                                    </select>
				                                </div>
				                            </td>
											<td><input class="hour-input" type="text" value="{% if timesheet_form.day_1_hours.value %}{{timesheet_form.day_1_hours.value}}{% endif %}" data-hours="{{timesheet_form.day_1_hours.value}}" data-ptr-total-hours="day_total_1_hours" placeholder="0.00" id="{{timesheet_form.day_1_hours.auto_id}}" name="{{timesheet_form.day_1_hours.html_name}}" /></td>
											<td><input class="hour-input" type="text" value="{% if timesheet_form.day_2_hours.value %}{{timesheet_form.day_2_hours.value}}{% endif %}" data-hours="{{timesheet_form.day_2_hours.value}}" data-ptr-total-hours="day_total_2_hours"  placeholder="0.00" id="{{timesheet_form.day_2_hours.auto_id}}" name="{{timesheet_form.day_2_hours.html_name}}" /></td>
											<td><input class="hour-input" type="text" value="{% if timesheet_form.day_3_hours.value %}{{timesheet_form.day_3_hours.value}}{% endif %}" data-hours="{{timesheet_form.day_3_hours.value}}" data-ptr-total-hours="day_total_3_hours"  placeholder="0.00" id="{{timesheet_form.day_3_hours.auto_id}}" name="{{timesheet_form.day_3_hours.html_name}}" /></td>
											<td><input class="hour-input" type="text" value="{% if timesheet_form.day_4_hours.value %}{{timesheet_form.day_4_hours.value}}{% endif %}" data-hours="{{timesheet_form.day_4_hours.value}}" data-ptr-total-hours="day_total_4_hours"  placeholder="0.00" id="{{timesheet_form.day_4_hours.auto_id}}" name="{{timesheet_form.day_4_hours.html_name}}" /></td>
											<td><input class="hour-input" type="text" value="{% if timesheet_form.day_5_hours.value %}{{timesheet_form.day_5_hours.value}}{% endif %}" data-hours="{{timesheet_form.day_5_hours.value}}" data-ptr-total-hours="day_total_5_hours"  placeholder="0.00" id="{{timesheet_form.day_5_hours.auto_id}}" name="{{timesheet_form.day_5_hours.html_name}}" /></td>
											<td><input class="hour-input" type="text" value="{% if timesheet_form.day_6_hours.value %}{{timesheet_form.day_6_hours.value}}{% endif %}" data-hours="{{timesheet_form.day_6_hours.value}}" data-ptr-total-hours="day_total_6_hours"  placeholder="0.00" id="{{timesheet_form.day_6_hours.auto_id}}" name="{{timesheet_form.day_6_hours.html_name}}" /></td>
											<td><input class="hour-input" type="text" value="{% if timesheet_form.day_7_hours.value %}{{timesheet_form.day_7_hours.value}}{% endif %}" data-hours="{{timesheet_form.day_7_hours.value}}" data-ptr-total-hours="day_total_7_hours"  placeholder="0.00" id="{{timesheet_form.day_7_hours.auto_id}}" name="{{timesheet_form.day_7_hours.html_name}}" /></td>
											<td><span id="{{timesheet_form.total_hours.auto_id}}">{{timesheet_form.initial.total_hours}}</span></td>
											<td></td>																										
									    </tr>									    
								 {% endfor %}									    
							</tbody>	
							<tfoot>
							     <tr>
							         <td></td>
							         <td></td>
							         <td><span  class="day_total_1_hours" style="display: block; margin-left: 15px;">{% total_hours_day week_snapshot 1 %}</span></td>
							         <td><span  class="day_total_2_hours" style="display: block; margin-left: 15px;">{% total_hours_day week_snapshot 2 %}</span></td>
							         <td><span  class="day_total_3_hours" style="display: block; margin-left: 15px;">{% total_hours_day week_snapshot 3 %}</span></td>
							         <td><span  class="day_total_4_hours" style="display: block; margin-left: 15px;">{% total_hours_day week_snapshot 4 %}</span></td>
							         <td><span  class="day_total_5_hours" style="display: block; margin-left: 15px;">{% total_hours_day week_snapshot 5 %}</span></td>
							         <td><span  class="day_total_6_hours" style="display: block; margin-left: 15px;">{% total_hours_day week_snapshot 6 %}</span></td>
							         <td><span  class="day_total_7_hours" style="display: block; margin-left: 15px;">{% total_hours_day week_snapshot 7 %}</span></td>
							         <td><span  class="total_hours" style="display: block; margin-left: 0;">{{week_snapshot.total_hours}}</span></td>
							         <td></td>
							     </tr>
							     
							</tfoot>						
						</table>
					</div>
				</div>
				<div class="span12 papier section" style="width:820px !important;">				   
					<input id="id_submit" type="submit" class="blue-button"
						style="float: right; margin-right: -5px;padding-right:20px;padding-left:20px;" value="Submit" /> 
					<input id="id_draft" type="submit" class="grey-button" style="float: right; margin-right: 10px;padding-right:25px;padding-left:25px;" value="Save" /> 
					<a href="#" class="reset">Reset</a>
				</div>
				<input type="hidden" name="is_draft" id="id_is_draft" value="true"/>	
				{{ timesheet_form_set.management_form }}
				<div style="display:none">				    
                    {{week_snapshot_form.as_p}}                                          
				</div>
			</form>
	</div>
</body>
</html>